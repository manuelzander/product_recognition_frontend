<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>OMEGAP Snapshot and Classification Page</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script type="text/javascript" src="{{ url_for('static', filename='webcamjs/webcam.js') }}"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

</head>

<body>

  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="http://127.0.0.1:5000/">OMEGAP</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="http://127.0.0.1:5000/">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/upload">Upload</a>
        </li>
      </ul>
    </div>
  </nav>

  <main role="main" class="flex-container">>

    <div class="modal-body row">
    <div class="col-md-6">

      <br>
      <h4>Image Capturing</h4>

      <div id="my_camera" style="margin: 0 auto; text-align: center; padding-top: 50px;"></div>
      <div id="snapshot-buttons" style="margin: 0 auto; text-align: center; padding-top: 80px;" >

          <form>
              <input type=button value="Start Predictions" onClick="take_snapshot_loop()">
              <input type=button value="Stop Predictions" onClick="stop_taking_snapshot()">
          </form>

          <img src="{{ url_for('static', filename='ocado.jpg') }}" style="width:733px;height:263px;">

      </div>

    </div>

    <div class="col-md-6">

      <br>
      <h4>Predictions</h4>
      <canvas id="myChart" width="400" height="250"></canvas>

      <!--<ul id="predictions">-->

    </div>
    </div>

  </main><!-- /.container -->

  <script>
    var ctx = document.getElementById("myChart").getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'bar',
      data: {
          labels: ["Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6"],
          datasets: [{
              label: 'Probability per class',
              data: [0.5, 0.5, 0.5, 0.5, 0.5, 0.5],
              backgroundColor: [
                  'rgba(255, 99, 132, 0.2)',
                  'rgba(54, 162, 235, 0.2)',
                  'rgba(255, 206, 86, 0.2)',
                  'rgba(75, 192, 192, 0.2)',
                  'rgba(153, 102, 255, 0.2)',
                  'rgba(255, 159, 64, 0.2)'
              ],
              borderColor: [
                  'rgba(255,99,132,1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)',
                  'rgba(255, 159, 64, 1)'
              ],
              borderWidth: 1
          }]
      },
      options: {
          scales: {
              yAxes: [{
                  ticks: {
                        max: 1,
                        min: 0,
                        stepSize: 0.1
                  }
              }]
          }
      }
  });
  </script>

  <script type="text/javascript" charset="utf-8">

    //Webcam set-up
    Webcam.set({
      width: 640,
      height: 512,
      image_format: 'jpeg',
      jpeg_quality: 90,
      constraints: {
        width: { exact: 640 },
        height: { exact: 512 }
      }
    });

		Webcam.attach( '#my_camera' );

    //SocketIO set-up and update of chart

    function addData(chart, data, datasetIndex) {
       chart.data.datasets[datasetIndex].data = data;
       chart.update();
    }

    var socket = io.connect('http://' + document.domain + ':' + location.port);

    var data = [];

    socket.on('scan', function(incoming_data) {
      //console.log(incoming_data);
      //$("#predictions").append($('<li>').text(msg.text));
      data = JSON.parse(incoming_data);
      addData(myChart, data, 0);
      //setTimeout(function() {
      //   addData(myChart, data, 0);
      //}, 100);
    });

    //Webcam functions
    var timer = null;

    function take_snapshot_loop() {
      //alert("Started taking pictures!");
      if (!timer) {
        take_snapshot();
        timer = setInterval( take_snapshot, 250 );
      }
    }

    function stop_taking_snapshot() {
      //alert("Stopped taking pictures!");
      if (timer) {
        clearTimeout(timer);
        timer = null;
      }
    }

    //Taking pictures with webcam
    function take_snapshot() {
          Webcam.snap( function(data_uri) {
          Webcam.upload( data_uri, "{{ url_for('send_to_server_webcam') }}", function(code, text) {
        });
      });
      }
	</script>

</body>

</html>
